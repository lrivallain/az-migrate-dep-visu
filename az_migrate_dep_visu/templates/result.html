{% extends "base.html" %}

{% block head %}
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css" />
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
{% endblock %}

{% block content %}
<div id="graph-caption">
    <p><strong>File:</strong> <code>{{ file_name }}</code></p>
    <div id="graph-configuration-container">
        <input class="form-check-input" type="checkbox" id="enable-clustering">
        <label class="form-check-label" for="enable-clustering">Group per VLAN</label>
        <input class="form-check-input" type="checkbox" id="group-nonrfc1918">
        <label class="form-check-label" for="group-nonrfc1918">Group Non-RFC1918</label>
    </div>
</div>
<div id="loading-bar" class="progress" role="progressbar">
    <div id="loading-bar-progress" class="progress-bar bg-success" style="width: 0%;">0%</div>
</div>
<div id="network"></div>
<div class="filter-container">
    <div class="form-group">
        <label for="source-ip-filter">Source IP:</label>
        <select id="source-ip-filter" class="form-select">
            <option value="">All</option>
            <option value="non-rfc1918">Non-RFC1918</option>
            <option value="rfc1918">RFC1918</option>
        </select>
    </div>
    <div class="form-group">
        <label for="destination-ip-filter">Destination IP:</label>
        <select id="destination-ip-filter" class="form-select">
            <option value="">All</option>
            <option value="non-rfc1918">Non-RFC1918</option>
            <option value="rfc1918">RFC1918</option>
        </select>
    </div>
    <div class="form-group">
        <label for="port-filter">Port:</label>
        <select id="port-filter" class="form-select">
            <option value="">All</option>
        </select>
    </div>
    <div class="form-group">
        <label for="source-vlan-filter">Source VLAN:</label>
        <select id="source-vlan-filter" class="form-select">
            <option value="">All</option>
        </select>
    </div>
    <div class="form-group">
        <label for="destination-vlan-filter">Destination VLAN:</label>
        <select id="destination-vlan-filter" class="form-select">
            <option value="">All</option>
        </select>
    </div>
    <div class="form-group">
        <label for="column-select">Select Columns:</label>
        <select id="column-select" class="form-select" multiple="multiple">
            <option value="0">Source Server Name</option>
            <option value="1" selected>Source IP</option>
            <option value="2">Source Application</option>
            <option value="3">Source Process</option>
            <option value="4">Destination Server Name</option>
            <option value="5" selected>Destination IP</option>
            <option value="6">Destination Application</option>
            <option value="7">Destination Process</option>
            <option value="8" selected>Destination Port</option>
            <option value="9">Source VLAN</option>
            <option value="10">Destination VLAN</option>
            <option value="11" selected>Count</option>
        </select>
    </div>
</div>
<table id="flows-table" class="table table-striped table-bordered" style="width:100%;">
    <thead>
        <tr>
            <th>Source Server Name</th>
            <th>Source IP</th>
            <th>Source Application</th>
            <th>Source Process</th>
            <th>Destination Server Name</th>
            <th>Destination IP</th>
            <th>Destination Application</th>
            <th>Destination Process</th>
            <th>Destination Port</th>
            <th>Source VLAN</th>
            <th>Destination VLAN</th>
            <th>Count</th>
        </tr>
    </thead>
    <tbody id="flows-table-body">
    </tbody>
</table>
<button id="download-csv" class="btn btn-success">Download CSV of the current selection</button>
<button id="reset-preferences" class="btn btn-secondary" type="button"
    data-bs-toggle="tooltip"
    data-bs-placement="top"
    data-bs-title="Your filtering and graph options are stored in a cookie.
        You can reset this by using the 'Reset preferences' button.">
    Reset preferences
</button>
<script src="{{ url_for('static', filename='scripts.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const csvData = `{{ csv_data | safe }}`;
        const rows = csvData.split('\n').slice(1);
        const data = rows.map(row => {
            const cols = row.split(',');
            return {
                source_server_name: cols[1],
                source: cols[2],
                source_application: cols[3],
                source_process: cols[4],
                destination_server_name: cols[5],
                target: cols[6],
                destination_application: cols[7],
                destination_process: cols[8],
                port: cols[9],
                source_vlan: cols[10],
                destination_vlan: cols[11],
                count: 1 // Assuming each row represents a single count
            };
        });

        // Group data by matching values and update count
        const groupedData = {};
        data.forEach(entry => {
            const key = `${entry.source_server_name}-${entry.source}-${entry.source_application}-${entry.source_process}-${entry.destination_server_name}-${entry.target}-${entry.destination_application}-${entry.destination_process}-${entry.port}-${entry.source_vlan}-${entry.destination_vlan}`;
            if (groupedData[key]) {
                groupedData[key].count += 1;
            } else {
                groupedData[key] = entry;
            }
        });

        const uniqueSourceIps = [...new Set(data.map(d => d.source))].sort();
        const uniqueDestinationIps = [...new Set(data.map(d => d.target))].sort();
        const uniquePorts = [...new Set(data.map(d => d.port))].sort((a, b) => a - b);
        const uniqueSourceVlans = [...new Set(data.map(d => d.source_vlan))].sort((a, b) => a - b);
        const uniqueDestinationVlans = [...new Set(data.map(d => d.destination_vlan))].sort((a, b) => a - b);

        const sourceIpFilter = document.getElementById('source-ip-filter');
        const destinationIpFilter = document.getElementById('destination-ip-filter');
        const portFilter = document.getElementById('port-filter');
        const sourceVlanFilter = document.getElementById('source-vlan-filter');
        const destinationVlanFilter = document.getElementById('destination-vlan-filter');

        uniqueSourceIps.forEach(ip => {
            const option = document.createElement('option');
            option.value = ip;
            option.textContent = ip;
            sourceIpFilter.appendChild(option);
        });

        uniqueDestinationIps.forEach(ip => {
            const option = document.createElement('option');
            option.value = ip;
            option.textContent = ip;
            destinationIpFilter.appendChild(option);
        });

        uniquePorts.forEach(port => {
            const option = document.createElement('option');
            option.value = port;
            option.textContent = port;
            portFilter.appendChild(option);
        });

        uniqueSourceVlans.forEach(vlan => {
            const option = document.createElement('option');
            option.value = vlan;
            option.textContent = vlan;
            sourceVlanFilter.appendChild(option);
        });

        uniqueDestinationVlans.forEach(vlan => {
            const option = document.createElement('option');
            option.value = vlan;
            option.textContent = vlan;
            destinationVlanFilter.appendChild(option);
        });

        const tableBody = document.getElementById('flows-table-body');
        Object.values(groupedData).forEach(entry => {
            const row = document.createElement('tr');
            Object.values(entry).forEach(value => {
                const cell = document.createElement('td');
                cell.textContent = value;
                row.appendChild(cell);
            });
            tableBody.appendChild(row);
        });

        table = $('#flows-table').DataTable();

        $('#column-select').on('change', function () {
            var selectedColumns = $(this).val();
            table.columns().visible(false);
            if (selectedColumns) {
                selectedColumns.forEach(function (colIndex) {
                    table.column(colIndex).visible(true);
                });
            }
            saveSettings();
        });

        $('#source-ip-filter, #destination-ip-filter, #port-filter, #source-vlan-filter, #destination-vlan-filter, #enable-clustering, #group-nonrfc1918').on('change', function () {
            var sourceIp = $('#source-ip-filter').val();
            var destinationIp = $('#destination-ip-filter').val();
            var port = $('#port-filter').val();
            var sourceVlan = $('#source-vlan-filter').val();
            var destinationVlan = $('#destination-vlan-filter').val();

            if (sourceIp === 'non-rfc1918') {
                table.column(1).search('^(?!10\\.|172\\.(1[6-9]|2[0-9]|3[0-1])\\.|192\\.168\\.).*$', true, false);
            } else if (sourceIp === 'rfc1918') {
                table.column(1).search('^(10\\.|172\\.(1[6-9]|2[0-9]|3[0-1])\\.|192\\.168\\.)', true, false);
            } else {
                table.column(1).search(sourceIp);
            }

            if (destinationIp === 'non-rfc1918') {
                table.column(5).search('^(?!10\\.|172\\.(1[6-9]|2[0-9]|3[0-1])\\.|192\\.168\\.).*$', true, false);
            } else if (destinationIp === 'rfc1918') {
                table.column(5).search('^(10\\.|172\\.(1[6-9]|2[0-9]|3[0-1])\\.|192\\.168\\.)', true, false);
            } else {
                table.column(5).search(destinationIp);
            }

            if (port) {
                table.column(8).search('^' + port + '$', true, false); // Exact match for port
            } else {
                table.column(8).search('');
            }

            if (sourceVlan) {
                table.column(9).search('^' + sourceVlan + '$', true, false); // Exact match for source VLAN
            } else {
                table.column(9).search('');
            }

            if (destinationVlan) {
                table.column(10).search('^' + destinationVlan + '$', true, false); // Exact match for destination VLAN
            } else {
                table.column(10).search('');
            }

            table.draw();

            if ($('#group-nonrfc1918').is(':checked')) {
                table.rows().every(function () {
                    var data = this.data();
                    if (!data.originalSource) {
                        data.originalSource = data[1];
                    }
                    if (!data.originalTarget) {
                        data.originalTarget = data[5];
                    }
                    if (!isRFC1918(data[1])) {
                        data[1] = 'non-rfc1918';
                    }
                    if (!isRFC1918(data[5])) {
                        data[5] = 'non-rfc1918';
                    }
                    this.data(data);
                });
            } else {
                table.rows().every(function () {
                    var data = this.data();
                    if (data[1] === 'non-rfc1918') {
                        data[1] = data.originalSource;
                    }
                    if (data[5] === 'non-rfc1918') {
                        data[5] = data.originalTarget;
                    }
                    this.data(data);
                });
            }

            updateFilters();
            updateGraph();
            saveSettings();
        });

        $('#flows-table_filter input').on('keyup change', function () {
            table.search(this.value).draw();
            updateGraph();
        });

        $('#download-csv').off('click').on('click', function () {
            downloadCSV();
        });

        updateGraph();
    });
</script>
{% endblock %}